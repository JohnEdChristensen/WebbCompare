YUI.add("hermes-template-photo-note-read-mode",(function(e,n){var l=e.Template.Handlebars.revive({1:function(e,n,l,a,t){var r,o=null!=n?n:e.nullContext||{},u=e.hooks.helperMissing,s=e.escapeExpression,i=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return'\t\t\t<span class="author">'+s("function"==typeof(r=null!=(r=i(l,"authorName")||(null!=n?i(n,"authorName"):n))?r:u)?r.call(o,{name:"authorName",hash:{},data:t,loc:{start:{line:4,column:24},end:{line:4,column:38}}}):r)+" ("+s((i(l,"intlMessage")||n&&i(n,"intlMessage")||u).call(o,{name:"intlMessage",hash:{intlName:"common.DELETED_USER"},data:t,loc:{start:{line:4,column:40},end:{line:4,column:86}}}))+")</span><br>\n"},3:function(e,n,l,a,t){var r,o,u=null!=n?n:e.nullContext||{},s=e.hooks.helperMissing,i="function",c=e.escapeExpression,p=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return'\t\t\t<a href="'+c(typeof(o=null!=(o=p(l,"authorURL")||(null!=n?p(n,"authorURL"):n))?o:s)===i?o.call(u,{name:"authorURL",hash:{},data:t,loc:{start:{line:6,column:12},end:{line:6,column:25}}}):o)+'" class="author">'+c(typeof(o=null!=(o=p(l,"authorName")||(null!=n?p(n,"authorName"):n))?o:s)===i?o.call(u,{name:"authorName",hash:{},data:t,loc:{start:{line:6,column:42},end:{line:6,column:56}}}):o)+"</a>"+(null!=(r=p(l,"if").call(u,null!=n?p(n,"authorIsPro"):n,{name:"if",hash:{},fn:e.program(4,t,0),inverse:e.noop,data:t,loc:{start:{line:6,column:60},end:{line:6,column:156}}}))?r:"")+"<br>\n"},4:function(e,n,l,a,t){var r,o=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return null!=(r=e.invokePartial(o(a,"pro-badge"),n,{name:"pro-badge",hash:{purchaseProURL:null!=n?o(n,"upgradeProLink"):n,badgeType:null!=n?o(n,"authorProBadge"):n},data:t,helpers:l,partials:a,decorators:e.decorators}))?r:""},compiler:[8,">= 4.3.0"],main:function(e,n,l,a,t){var r,o,u=null!=n?n:e.nullContext||{},s=e.hooks.helperMissing,i="function",c=e.escapeExpression,p=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return'<div class="note-text" style="z-index:'+c(typeof(o=null!=(o=p(l,"z")||(null!=n?p(n,"z"):n))?o:s)===i?o.call(u,{name:"z",hash:{},data:t,loc:{start:{line:1,column:38},end:{line:1,column:43}}}):o)+';">\n\t<div class="text-alignment-fix hyphenate" style="left:'+c(typeof(o=null!=(o=p(l,"x")||(null!=n?p(n,"x"):n))?o:s)===i?o.call(u,{name:"x",hash:{},data:t,loc:{start:{line:2,column:55},end:{line:2,column:60}}}):o)+"px;top:"+c(typeof(o=null!=(o=p(l,"y")||(null!=n?p(n,"y"):n))?o:s)===i?o.call(u,{name:"y",hash:{},data:t,loc:{start:{line:2,column:67},end:{line:2,column:72}}}):o)+'px">\n'+(null!=(r=p(l,"if").call(u,null!=n?p(n,"authorIsDeleted"):n,{name:"if",hash:{},fn:e.program(1,t,0),inverse:e.program(3,t,0),data:t,loc:{start:{line:3,column:2},end:{line:7,column:9}}}))?r:"")+"\t\t"+c((p(l,"renderTrustedMarkup")||n&&p(n,"renderTrustedMarkup")||s).call(u,null!=n?p(n,"text"):n,{name:"renderTrustedMarkup",hash:{},data:t,loc:{start:{line:8,column:2},end:{line:8,column:30}}}))+"\n\t</div>\n</div>\n"},usePartial:!0,useData:!0}),a={};e.Array.each(["pro-badge"],(function(n){var l=e.Template.get("hermes/"+n);l&&(a[n]=l)})),e.Template.register("hermes/photo-note-read-mode",(function(n,t){return(t=t||{}).partials=t.partials?e.merge(a,t.partials):a,l(n,t)}))}),"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-pro-badge"]});YUI.add("hermes-template-photo-note-write-mode",(function(e,n){var t=e.Template.Handlebars.revive({1:function(e,n,t,l,a){var o=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return'<button class="delete-note danger tiny">'+e.escapeExpression((o(t,"intlMessage")||n&&o(n,"intlMessage")||e.hooks.helperMissing).call(null!=n?n:e.nullContext||{},{name:"intlMessage",hash:{intlName:"common.DELETE"},data:a,loc:{start:{line:7,column:61},end:{line:7,column:101}}}))+"</button>"},compiler:[8,">= 4.3.0"],main:function(e,n,t,l,a){var o,s,i=null!=n?n:e.nullContext||{},c=e.hooks.helperMissing,r="function",u=e.escapeExpression,m=e.lookupProperty||function(e,n){if(Object.prototype.hasOwnProperty.call(e,n))return e[n]};return'<div class="note-text adding" data-for-note-yuid="'+u(typeof(s=null!=(s=m(t,"noteYUID")||(null!=n?m(n,"noteYUID"):n))?s:c)===r?s.call(i,{name:"noteYUID",hash:{},data:a,loc:{start:{line:1,column:50},end:{line:1,column:62}}}):s)+'" style="z-index:'+u(typeof(s=null!=(s=m(t,"z")||(null!=n?m(n,"z"):n))?s:c)===r?s.call(i,{name:"z",hash:{},data:a,loc:{start:{line:1,column:79},end:{line:1,column:84}}}):s)+';">\n\t<div class="text-alignment-fix hyphenate" style="left:'+u(typeof(s=null!=(s=m(t,"x")||(null!=n?m(n,"x"):n))?s:c)===r?s.call(i,{name:"x",hash:{},data:a,loc:{start:{line:2,column:55},end:{line:2,column:60}}}):s)+"px;top:"+u(typeof(s=null!=(s=m(t,"y")||(null!=n?m(n,"y"):n))?s:c)===r?s.call(i,{name:"y",hash:{},data:a,loc:{start:{line:2,column:67},end:{line:2,column:72}}}):s)+'px">\n\t\t<textarea class="note-text-textarea unfluid" placeholder="'+u((m(t,"intlMessage")||n&&m(n,"intlMessage")||c).call(i,{name:"intlMessage",hash:{intlName:"photo-page-scrappy.ADD_A_NOTE"},data:a,loc:{start:{line:3,column:60},end:{line:3,column:116}}}))+'">'+u(typeof(s=null!=(s=m(t,"text")||(null!=n?m(n,"text"):n))?s:c)===r?s.call(i,{name:"text",hash:{},data:a,loc:{start:{line:3,column:118},end:{line:3,column:128}}}):s)+'</textarea>\n\t\t<div class="note-text-buttons">\n\t\t\t<button class="save-note tiny">'+u((m(t,"intlMessage")||n&&m(n,"intlMessage")||c).call(i,{name:"intlMessage",hash:{intlName:"common.SAVE"},data:a,loc:{start:{line:5,column:34},end:{line:5,column:74}}}))+'</button>\n\t\t\t<button class="cancel-note alt tiny">'+u((m(t,"intlMessage")||n&&m(n,"intlMessage")||c).call(i,{name:"intlMessage",hash:{intlName:"common.CANCEL"},data:a,loc:{start:{line:6,column:40},end:{line:6,column:82}}}))+"</button>"+(null!=(o=m(t,"if").call(i,null!=n?m(n,"canDelete"):n,{name:"if",hash:{},fn:e.program(1,a,0),inverse:e.noop,data:a,loc:{start:{line:7,column:3},end:{line:7,column:117}}}))?o:"")+"\n\t\t</div>\n\t</div>\n</div>"},useData:!0}),l={};e.Array.each([],(function(n){var t=e.Template.get("hermes/"+n);t&&(l[n]=t)})),e.Template.register("hermes/photo-note-write-mode",(function(n,a){return(a=a||{}).partials=a.partials?e.merge(l,a.partials):l,t(n,a)}))}),"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("hermes-template-photo-note-drag-handles",(function(a,e){var r=a.Template.Handlebars.revive({compiler:[8,">= 4.3.0"],main:function(a,e,r,n,t){return'<span class="note-drag-handle note-drag-handle-tl" data-drag-resize-direction="tl"></span><span class="note-drag-handle note-drag-handle-tr" data-drag-resize-direction="tr"></span><span class="note-drag-handle note-drag-handle-br" data-drag-resize-direction="br"></span><span class="note-drag-handle note-drag-handle-bl" data-drag-resize-direction="bl"></span>'},useData:!0}),n={};a.Array.each([],(function(e){var r=a.Template.get("hermes/"+e);r&&(n[e]=r)})),a.Template.register("hermes/photo-note-drag-handles",(function(e,t){return(t=t||{}).partials=t.partials?a.merge(n,t.partials):n,r(e,t)}))}),"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("photo-notes-scrappy-view",(function(e,t){var o=new e.SubscriptionsHelper;function i(t){this.yuid=e.guid(),this.id=t.id,this.photoId=t.photoId,this.x=t.x,this.y=t.y,this.z=0,this.w=t.w,this.h=t.h,this.text=t.text,this.author=t.author,this.authorName=t.authorName,this.authorRealName=t.authorRealName,this.authorIsPro=t.authorIsPro,this.authorProBadge=t.authorProBadge,this.authorIsDeleted=t.authorIsDeleted,this.canEdit=t.canEdit,this.canDelete=t.canDelete,this.isStoredOnServer=t.isStoredOnServer}i.prototype.getScaled=function(e){return{x:this.x*e,y:this.y*e,w:this.w*e,h:this.h*e}};var n=1,a={idle:{begin:"beginIdle",end:"endIdle",events:{mousedown:"handleIdleMouseDown",mouseup:"handleIdleMouseUp",mouseenter:{handler:"handleIdleMouseEnter",delegate:".note"},mouseleave:{handler:"handleIdleMouseLeave",delegate:".note"}}},editing:{begin:"beginEditing",events:{mousedown:"handleEditingMouseDown",mouseup:"handleEditingMouseUp",keydown:"handleEditingKeyDown"}},dragging:{begin:"beginDragging",end:"endDragging",events:{mousemove:"handleDraggingMouseMove",mouseup:"handleDraggingMouseUp"}}};e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,initializer:function(e){return""===this.get("container").get("innerHTML")&&this.setContainerHTML(""),this.stateEventHandles=[],this},loadState:function(){var t,o=this;return t={photo:this.appContext.getModel("photo-models",this._params.photoId),photoNotes:this.appContext.getModel("photo-notes-models",this._params.photoId),noteModel:this.appContext.getModelRegistry("note-models")},this.appContext.getViewer().signedIn&&this.appContext.getViewer().nsid&&(t.viewer=this.appContext.getModel("person-models",this.appContext.getViewer().nsid)),new e.FlickrPromise(t).then((function(e){o.set("photoModel",e.photo),o.set("photoNotesModel",e.photoNotes),o.set("noteModel",e.noteModel),e.viewer&&o.set("viewer",e.viewer)}))},buildContainer:function(){return this},activate:function(){var t,o,n,a,s=this.appContext.flipper.isFlipped("enable-scrappy-notes-deleting"),r=this.appContext.flipper.isFlipped("enable-scrappy-notes-editing"),h=this.get("photoModel"),d=h.getValue("owner").getValue("id"),l=this.appContext.getViewer().signedIn&&this.appContext.getViewer().nsid,g=this.get("photoNotesModel").getValue("notes").toJSON();if(h.getValue("isVideo"))return this.deactivate(),this;for(this.box=this.get("container"),this.notes=[],this.canAddNotes=h.getValue("canAddMeta"),this.canAddNotes&&this.box.setStyle("pointerEvents","auto"),this.registerEventHandler(this.box.on("mouseenter",this.revealNotes.bind(this))),this.registerEventHandler(this.box.on("mouseleave",this.hideNotes.bind(this))),this.registerEventHandler(e.on("photo:entering-vr",this.deactivate.bind(this))),o=0;o<g.length;o++)t=g[o],n=r&&(l===d||l===t.author),a=s&&(l===d||l===t.author),this.notes.push(new i({id:t.id,photoId:h.getValue("id"),x:t.left,y:t.top,w:t.width,h:t.height,text:t.text,author:t.author,authorName:t.authorName,authorRealName:t.authorRealName,authorIsPro:t.authorIsPro,authorProBadge:t.authorProBadge,authorIsDeleted:t.authorIsDeleted,canEdit:n,canDelete:a,isStoredOnServer:!0}));return this.restackNotes(),this.syncWithPhoto(),this.renderNotes(),this.box.addClass("is-ready"),this.onCSSLoaded(this.syncWithPhoto),this.revealNotes(),this.pageLoadNotesFlashTimer=setTimeout(this.hideNotes.bind(this),1e3),this.enterState("idle"),this},onParentViewEvent:function(e,t){t&&"photoWellResized"===t[0]&&this.isActivated&&this.box&&(this.syncWithPhoto(),this.renderNotes())},enterState:function(e,t){var o;if(t=t||{},a[e]){for(;this.stateEventHandles.length;)this.stateEventHandles.pop().detach();for(var i in this.currentState&&a[this.currentState].end&&this[a[this.currentState].end]&&this[a[this.currentState].end].call(this,t),a[e].events)"string"==typeof(o=a[e].events[i])?this.stateEventHandles.push(this.box.on(i,this[o].bind(this))):"object"==typeof o&&(o.delegate?this.stateEventHandles.push(this.box.delegate(i,this[o.handler].bind(this),o.delegate)):this.stateEventHandles.push(this.box.on(i,this[o.handler].bind(this))));a[e].begin&&this[a[e].begin]&&this[a[e].begin].call(this,t),this.currentState=e}},revealNotes:function(e){this.box.addClass("box-hovered"),clearTimeout(this.pageLoadNotesFlashTimer)},hideNotes:function(){this.box.removeClass("box-hovered"),this.hideHovered()},beginIdle:function(e){var t=e.element;this.box.removeClass("box-note-clicked"),delete this.draggingMemo,this.box.all(".note-text").remove(!0),t&&t.getDOMNode()&&t.removeClass("note-clicked"),e.rerender&&(this.restackNotes(),this.renderNotes())},endIdle:function(e){this.tempMouseMoveListener&&(this.tempMouseMoveListener.detach(),delete this.tempMouseMoveListener)},handleIdleMouseDown:function(t){var o,n,a,s,r=!1;1!==t.button||t.ctrlKey||t.metaKey||t.target.hasClass("note-text")||(t.target.hasClass("note")&&(o=this.getNoteByID(t.target.getAttribute("data-note-yuid"))),o&&(o.canEdit||o.canDelete)?this.enterState("editing",{note:o,element:t.target}):(a={x:t.clientX,y:t.clientY},s=this.box.getXY(),this.canAddNotes&&(t.preventDefault(),this.tempMouseMoveListener=this.box.on("mousemove",function(t){var o,h,d,l;if(o="",!(Math.sqrt(Math.pow(t.clientX-a.x,2)+Math.pow(t.clientY-a.y,2))<20)){switch(r||(r=!0,this.box.addClass("doing-initial-drag")),o+=a.y-t.clientY>=0?"t":"b",o+=a.x-t.clientX>=0?"l":"r"){case"tl":d=0,l=0;break;case"tr":d=8,l=0;break;case"bl":d=0,l=8;break;case"br":d=8,l=8}h=this.get("viewer"),n=new i({id:e.guid(),photoId:this.get("photoModel").getValue("id"),x:(Math.min(a.x,t.clientX)-s[0]+window.pageXOffset)/this.ratio,y:(Math.min(a.y,t.clientY)-s[1]+window.pageYOffset)/this.ratio,w:Math.abs(a.x-t.clientX)/this.ratio-d,h:Math.abs(a.y-t.clientY)/this.ratio-l,text:"",author:h.getValue("nsid"),authorName:h.getValue("username"),authorRealName:h.getValue("displayname"),authorIsPro:h.getValue("isPro"),authorProBadge:h.getValue("proBadge"),authorIsDeleted:!1,canEdit:!0,canDelete:!0,isStoredOnServer:!1}),this.notes.push(n),this.createNewNote(n),this.storeNoteBackup(n),n.node.append(this.templates("photo-note-drag-handles")()),this.box.addClass("box-note-clicked"),n.node.addClass("note-clicked"),n.node.addClass("note-can-edit"),this.enterState("dragging",{note:n,element:n.node,dragMetadata:{type:"resize",startX:Math.min(a.x,t.clientX)+window.pageXOffset,startY:Math.min(a.y,t.clientY)+window.pageYOffset,dragHandle:n.node.one(".note-drag-handle-"+o),direction:o}})}}.bind(this)))))},handleIdleMouseUp:function(t){this.tempMouseMoveListener&&(this.tempMouseMoveListener.detach(),delete this.tempMouseMoveListener),t.target===this.box&&e.fire("photo:zoom",{x:t.pageX,y:t.pageY,shift:t.shiftKey})},handleIdleMouseEnter:function(e){var t,i=e.target.ancestor(".note",!0),a=this.getNoteByID(i.getAttribute("data-note-yuid")),s=a.getScaled(this.ratio);this.delayedNoteMouseLeaveHandler&&(this.hideHovered(),clearTimeout(this.delayedNoteMouseLeaveHandler),delete this.delayedNoteMouseLeaveHandler),i.addClass("note-hovered"),i.insert(this.templates("photo-note-read-mode")({x:s.x,y:s.y+s.h+2,z:n,text:a.text.replace(/\n/g,"<br>"),authorName:a.authorRealName||a.authorName,authorURL:"/photos/"+a.author+"/",authorIsPro:a.authorIsPro,authorProBadge:a.authorProBadge,authorIsDeleted:a.authorIsDeleted,upgradeProLink:o.getProLandingPageUrl(o.UTM_PRO_BADGE,{utm_medium:this.name})}),"after"),(t=this.box.one(".note-text")).get("region").width+s.x>window.innerWidth&&t.one(".text-alignment-fix").setStyle("left",s.x-t.get("region").width+s.w+"px"),t.on("mouseenter",function(e){this.delayedNoteMouseLeaveHandler&&(clearTimeout(this.delayedNoteMouseLeaveHandler),delete this.delayedNoteMouseLeaveHandler)}.bind(this)),t.on("mouseleave",this.handleIdleMouseLeave.bind(this))},handleIdleMouseLeave:function(e){this.delayedNoteMouseLeaveHandler=setTimeout(this.hideHovered.bind(this),100)},beginEditing:function(e){var t,o=e.note,i=e.element,a=o.getScaled(this.ratio);this.storeNoteBackup(o),this.hideHovered(),this.box.hasClass("box-note-clicked")||this.box.addClass("box-note-clicked"),i.hasClass("note-clicked")||i.addClass("note-clicked"),0===i.siblings(".note-text.adding").size()&&i.insert(this.templates("photo-note-write-mode")({noteYUID:o.yuid,x:a.x,y:a.y+a.h+2,z:n,text:o.text.replace(/&quot;/g,'"').replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&"),canDelete:o.isStoredOnServer}),"after"),(t=this.box.one(".note-text")).get("region").width+a.x>window.innerWidth&&t.one(".text-alignment-fix").setStyle("left",a.x-t.get("region").width+a.w+"px"),i.one(".note-drag-handle")||i.append(this.templates("photo-note-drag-handles")()),setTimeout(function(){this.box.one(".note-text[data-for-note-yuid="+o.yuid+"] textarea").focus()}.bind(this),10)},handleEditingMouseDown:function(e){var t,o,i;1!==e.button||e.ctrlKey||e.metaKey||(o=e.target.ancestor(".note",!0))&&(t=this.getNoteByID(o.getAttribute("data-note-yuid")))&&t.canEdit&&(e.target.hasClass("note-drag-handle")?i={type:"resize",startX:e.clientX+window.pageXOffset,startY:e.clientY+window.pageYOffset,dragHandle:e.target,direction:e.target.getAttribute("data-drag-resize-direction")}:e.target.hasClass("note-clicked")&&(i={type:"move",startX:e.clientX+window.pageXOffset,startY:e.clientY+window.pageYOffset,dragHandle:e.target}),i&&this.enterState("dragging",{note:t,element:o,dragMetadata:i}))},handleEditingMouseUp:function(e){e.target.test("button")&&this.performButtonAction(e)},handleEditingKeyDown:function(e){var t=this.box.one(".note-clicked"),o=this.getNoteByID(t.getAttribute("data-note-yuid"));switch(e.keyCode){case 8:(e.ctrlKey||e.metaKey)&&window.confirm(this.intlMessage({intlName:"photo-page-scrappy.CONFIRM_NOTE_DELETION"}))&&(this.deleteNote(o,t),e.preventDefault());break;case 13:(e.ctrlKey||e.metaKey)&&(this.saveNoteEdits(o,t),e.preventDefault()),e.target.test("button")&&this.performButtonAction(e);break;case 27:this.cancelNoteEdits(o,t);break;case 32:e.target.test("button")&&this.performButtonAction(e)}},performButtonAction:function(e){var t=this.box.one(".note-clicked"),o=this.getNoteByID(t.getAttribute("data-note-yuid"));e.target.hasClass("save-note")?this.saveNoteEdits(o,t):e.target.hasClass("cancel-note")?this.cancelNoteEdits(o,t):e.target.hasClass("delete-note")&&window.confirm(this.intlMessage({intlName:"photo-page-scrappy.CONFIRM_NOTE_DELETION"}))&&this.deleteNote(o,t)},saveNoteEdits:function(e,t){var o=this.get("noteModel"),i=this;e.text=i.box.one(".note-text[data-for-note-yuid="+e.yuid+"] textarea").get("value").trim(),e.text&&(e.isStoredOnServer?(o.setValues(e.id,{left:e.x,top:e.y,width:e.w,height:e.h,text:e.text}),o.remoteUpdate(e.id).then((function(o){o&&(e.text=o.getValue("text")),i.deleteNoteBackup(),i.enterState("idle",{note:e,element:t,rerender:!0})}),(function(e){}))):o.remoteCreate({photoId:e.photoId,left:e.x,top:e.y,width:e.w,height:e.h,text:e.text,author:e.author,authorName:e.authorName,authorRealName:e.authorRealName,authorIsPro:e.authorIsPro,authorProBadge:e.authorProBadge,authorIsDeleted:!1}).then((function(o){e.id=o.getValue("id"),e.text=o.getValue("text"),e.isStoredOnServer=!0,i.deleteNoteBackup(),i.enterState("idle",{note:e,element:t,rerender:!0})}),(function(e){})))},cancelNoteEdits:function(e,t){var o;e.isStoredOnServer?(o=this.getNoteBackup(),e.w=o.w,e.h=o.h,e.x=o.x,e.y=o.y,this.positionNote(e)):(this.notes.pop(),this.box.one("[data-note-yuid="+e.yuid+"]").remove(!0),e=null,t=null),this.deleteNoteBackup(),this.enterState("idle",{note:e,element:t})},deleteNote:function(e,t){var o,i=this.get("noteModel"),n=this,a=!1;i.remoteDelete(e.id).then((function(i){for(t.remove(!0),o=n.notes.length-1;o>=0;o--)if(n.notes[o].id===e.id){a=!0;break}a&&n.notes.splice(o,1),n.deleteNoteBackup(),n.enterState("idle",{note:e,element:t})}),(function(e){}))},beginDragging:function(t){this.draggingMemo=e.merge(t.dragMetadata,{note:t.note,noteAtStart:e.clone(t.note),element:t.element})},endDragging:function(e){this.box.removeClass("doing-initial-drag")},handleDraggingMouseMove:function(e){var t,o,i,n,a,s,r,h,d,l,g,u,c,p=19/this.ratio;if(t=this.draggingMemo.note,o=this.draggingMemo.startX-e.clientX-window.pageXOffset,i=this.draggingMemo.startY-e.clientY-window.pageYOffset,this.boxWidth>this.boxHeight?(u=500,c=500/(this.boxWidth/this.boxHeight)):(c=500,u=500/(this.boxHeight/this.boxWidth)),"resize"===this.draggingMemo.type){switch(this.draggingMemo.direction){case"tl":n=o/this.ratio*-1,s=o/this.ratio,a=i/this.ratio*-1,r=i/this.ratio;break;case"tr":n=0,s=o/this.ratio*-1,a=i/this.ratio*-1,r=i/this.ratio;break;case"br":n=0,s=o/this.ratio*-1,a=0,r=i/this.ratio*-1;break;case"bl":n=o/this.ratio*-1,s=o/this.ratio,a=0,r=i/this.ratio*-1}h=this.draggingMemo.noteAtStart.x+n,l=this.draggingMemo.noteAtStart.w+s,d=this.draggingMemo.noteAtStart.y+a,g=this.draggingMemo.noteAtStart.h+r,l<p&&(n&&(h=this.draggingMemo.noteAtStart.w+this.draggingMemo.noteAtStart.x-p),l=p),l+h>u&&(l=u-h),h<0&&(h=0,l=this.draggingMemo.noteAtStart.w+this.draggingMemo.noteAtStart.x),t.x=h,t.w=l,g<p&&(a&&(d=this.draggingMemo.noteAtStart.h+this.draggingMemo.noteAtStart.y-p),g=p),g+d>c&&(g=c-d),d<0&&(d=0,g=this.draggingMemo.noteAtStart.h+this.draggingMemo.noteAtStart.y),t.y=d,t.h=g}else"move"===this.draggingMemo.type&&(h=this.draggingMemo.noteAtStart.x-o/this.ratio,d=this.draggingMemo.noteAtStart.y-i/this.ratio,h<0&&(h=0),h+this.draggingMemo.noteAtStart.w>u&&(h=u-this.draggingMemo.noteAtStart.w),d<0&&(d=0),d+this.draggingMemo.noteAtStart.h>c&&(d=c-this.draggingMemo.noteAtStart.h),t.x=h,t.y=d);this.positionNote(t)},handleDraggingMouseUp:function(e){this.enterState("editing",{note:this.draggingMemo.note,element:this.draggingMemo.element})},storeNoteBackup:function(t){this.noteBeforeEdits||(this.noteBeforeEdits=e.clone(t))},getNoteBackup:function(){return this.noteBeforeEdits},deleteNoteBackup:function(){delete this.noteBeforeEdits},getNoteByID:function(e){return this.notes.find?this.notes.find((function(t){return t.yuid===e})):this.notes.filter((function(t){return t.yuid===e}))[0]},renderNotes:function(){var t,o,i=this.getNoteBackup();i&&(t=e.clone(i.node.getDOMNode())),this.box.all(".note").remove(!0),this.notes.forEach(this.createNewNote.bind(this)),i&&((o=this.box.one("[data-note-yuid="+i.yuid+"]")).set("className",t.className),i.node=o)},createNewNote:function(t){t.node=e.Node.create('<span class="note" data-note-yuid="'+t.yuid+'"></span>'),t.canEdit&&t.node.addClass("note-can-edit"),this.box.append(t.node),this.positionNote(t)},positionNote:function(e){var t,o=e.getScaled(this.ratio);e.node.setStyles({left:o.x+"px",top:o.y+"px",width:o.w+"px",height:o.h+"px",zIndex:e.z}),(t=this.box.one(".note-text[data-for-note-yuid="+e.yuid+"]"))&&(t.setStyle("z-index",n),t.one(".text-alignment-fix").setStyles({left:o.x+"px",top:o.y+o.h+2+"px"}))},restackNotes:function(){this.notes.sort((function(e,t){return t.w*t.h-e.w*e.h})).forEach((function(e){e.z=n++}))},syncWithPhoto:function(){var t=e.one(".photo-well-media-scrappy-view").getDOMNode(),o=parseInt(getComputedStyle(t).paddingTop,10),i=parseInt(getComputedStyle(t).paddingBottom,10),n=t.offsetWidth,a=t.offsetHeight-o-i,s=t.offsetLeft,r=t.offsetTop+o;this.box.setStyles({width:n+"px",height:a+"px",left:s+"px",top:r+"px"}),this.ratio=Math.max(n,a)/500,this.boxWidth=n,this.boxHeight=a,this.boxLeft=s,this.boxTop=r},hideHovered:function(){this.box.all(".note-hovered").removeClass("note-hovered"),this.box.all(".note-text:not(.adding)").remove(!0)},deactivate:function(){this.get("container").setStyle("display","none").remove()}})}),"@VERSION@",{requires:["hermes-template-photo-note-read-mode","hermes-template-photo-note-write-mode","hermes-template-photo-note-drag-handles","flickr-view","subscriptions-helper"],optional:["photo-notes-models","photo-models"],langBundles:["common","photo-page-scrappy"]});